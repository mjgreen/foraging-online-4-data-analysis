---
title: "foraging-online-4"
output: 
  html_document:
    # toc: true
    keep_md: TRUE
---
<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, comment=NA, warning=FALSE, message=F)
options(width = 220)
```

```{r libs, message=F}
if(!require(tidyverse)){install.packages("tidyverse")}
if(!require(ggpubr)){install.packages("ggpubr")} # for correlation geom, see  https://rpkgs.datanovia.com/ggpubr/reference/stat_cor.html
if(!require(modelr)){install.packages("modelr")}
if(!require(hexbin)){install.packages("hexbin")}
```

```{r, echo=F}
ini=read_csv('d3_trial_by_trial.csv')
```

```{r, echo=F}
with(ini,xtabs(~subject+trial))
```

A full design would have 22 * 20 = 440 rows. Actually there are 427 rows. All the (13) missing trials are from subject 6.

Mean rejection rates per subject

```{r, out.width="30%"}
ini$subject=as_factor(ini$subject)
ggplot(ini, aes(x=subject, y=ignap)) + theme_bw()+
  facet_wrap(~condition, scales='free_x')+
  stat_summary(geom='pointrange',fun.data='mean_se',color='black')+
  stat_summary(geom='point',fun = 'mean', pch=21, color='red',fill='red', size=5)+
  stat_summary(aes(y=ignba),geom='pointrange',fun.data='mean_se',color='yellow')+
  stat_summary(aes(y=ignba),geom='point',fun = 'mean', pch=21, color='yellow',fill='yellow', size=3)+
  labs(subtitle='mean apple rejection rates per subject')+
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(), aspect.ratio = 1)+
  geom_hline(yintercept=0)
```

Look at the data before excluding anything.

```{r, 'Score against rejection rate ', echo=FALSE, out.width="30%"}
tbt <- read_csv("d3_trial_by_trial.csv", col_types=cols(condition=col_factor(), subject=col_factor(), trial=col_factor(), score=col_integer(), ignap=col_double(), ignba=col_double(), icint=col_double())) %>% 
  pivot_longer(cols=c(ignap),names_to='apples', values_to='rejection_rate_for_apples') %>% 
  mutate(condition=factor(condition, levels=c("hi10lo70","hi40lo40"), labels=c("10 bananas 70 apples", "40 bananas 40 apples"))) %>% 
  mutate(trial=as.numeric(trial)) %>% 
  mutate(subject=as.numeric(subject))

ggplot(tbt, aes(rejection_rate_for_apples, score)) + 
  scale_color_manual(values=c("blue","red")) +
  geom_jitter() + 
  geom_smooth(aes(color=condition))+
  theme(aspect.ratio = 1) + 
  facet_wrap(~condition) +
  theme(legend.position="top", axis.title.y = element_text(angle = 0, vjust=0.5))+
  labs(subtitle="The effect of rejection rate on scores")

ggplot(tbt, aes(trial, score)) + 
  scale_color_manual(values=c("blue","red")) +
  geom_jitter() + 
  geom_smooth(aes(color=condition))+
  theme(aspect.ratio = 1) + 
  facet_wrap(~condition) +
  theme(legend.position="top", axis.title.y = element_text(angle = 0, vjust=0.5))+
  labs(subtitle="The effect of fatigue on scores")

ggplot(tbt, aes(trial, rejection_rate_for_apples)) +
  scale_color_manual(values=c("blue","red")) +
  geom_jitter() +
  geom_smooth(aes(color=condition))+
  theme(aspect.ratio = 1) + 
  facet_wrap(~condition) +
  theme(legend.position="top", axis.title.y = element_text(angle = 0, vjust=0.5))+
  ylab("reject\nrate\napples")+labs(subtitle="Rejection rate increases over trials")
```

Rejection rate of 0 means they ate every apple they came across and they came across at least one. Replace with NA because they are not doing the rejection behaviour at all (not just not doing it very much).

```{r}
tbt <- tbt %>% mutate(rejection_rate_for_apples=ifelse(rejection_rate_for_apples==0,NA,rejection_rate_for_apples)) 
```

Remove 173 trials for not doing the rejection behaviour (NA rejection_rate_for_apples)

```{r}
tbt <- tbt %>% filter(!is.na(rejection_rate_for_apples))
```

Remove 3 remaining NA rows for having NA banana rejection rate - meaning that they didn't encounter any bananas at all after a full minute of searching.

```{r}
tbt <- tbt %>% filter(!is.na(ignba))
```

251 trials left out of 440. Show which subjects had which trials removed.

```{r}
with(tbt,xtabs(~subject+trial))
```

After pruning the data

```{r, echo=FALSE, out.width="30%"}
ggplot(tbt, aes(rejection_rate_for_apples, score)) + 
  scale_color_manual(values=c("blue","red")) +
  geom_jitter() + 
  geom_smooth(aes(color=condition))+
  theme(aspect.ratio = 1) + 
  facet_wrap(~condition) +
  theme(legend.position="top", axis.title.y = element_text(angle = 0, vjust=0.5))+
  labs(subtitle="The effect of rejection rate on scores")

ggplot(tbt, aes(trial, score)) + 
  scale_color_manual(values=c("blue","red")) +
  geom_jitter() + 
  geom_smooth(aes(color=condition))+
  theme(aspect.ratio = 1) + 
  facet_wrap(~condition) +
  theme(legend.position="top", axis.title.y = element_text(angle = 0, vjust=0.5))+
  labs(subtitle="The effect of fatigue on scores")

ggplot(tbt, aes(trial, rejection_rate_for_apples)) +
  scale_color_manual(values=c("blue","red")) +
  geom_jitter() +
  geom_smooth(aes(color=condition))+
  theme(aspect.ratio = 1) + 
  facet_wrap(~condition) +
  theme(legend.position="top", axis.title.y = element_text(angle = 0, vjust=0.5)) +
  ylab("reject\nrate\napples")+labs(subtitle="Rejection rate increases over trials")
```



<!-- Score gets worse over trials - the effect of fatigue -->

<!-- ```{r} -->
<!-- ggplot(tbt, aes(trial, score)) + -->
<!--   scale_color_manual(values=c("blue","red")) + -->
<!--   facet_wrap(~condition) + -->
<!--   geom_smooth(method='lm', aes(color=condition)) + -->
<!--   geom_point() -->
<!-- ``` -->

<!-- Rejection strategy increases scores in the frequent-high-value condition only -->

<!-- ```{r} -->
<!-- ggplot(tbt, aes(rejection_rate_for_apples, score)) + -->
<!--   scale_color_manual(values=c("blue","red")) + -->
<!--   facet_wrap(~condition) + -->
<!--   geom_smooth(aes(color=condition)) + -->
<!--   geom_point() -->

<!-- ``` -->



## First for the condition with 40 bananas and 40 apples, hi40lo40

We want to remove the effect of fatigue from the score.

```{r, echo=T}
freqhi <- subset(tbt, condition=="40 bananas 40 apples") 
```

First build a model of the influence of trial fatigue.

```{r, echo=TRUE}
mod <- lm(score ~ trial, data = freqhi)
```

Now make a grid to generate predictions. 

```{r, echo=T}
grid <- freqhi %>% 
  data_grid(trial) %>% 
  add_predictions(mod, "score")
```

Plot the predictions (in black) over the raw data (in red) in the left-hand plot. The model captures the effect of fatigue quite well. In the middle plot show the residual scores after the effect of fatigue is factored out (i.e., the deviation from the score expected given the fatigue accrued over trials). In the right-hand plot show how residualised score is affected by rejection strategy - i.e., how rejection rate affects the component of score that is unexplained by fatigue.

```{r, out.width="30%"}
ggplot(subset(tbt, condition=="40 bananas 40 apples"), aes(trial, score)) +
  geom_jitter(color='red') +
  geom_point(data=grid, color='black', size=4)

freqhi <- freqhi %>% 
  add_residuals(mod)
freqhi %>% 
  ggplot(aes(trial, resid), color='red') +
  geom_ref_line(h=0)+
  geom_jitter()+
  geom_smooth(color='red')

ggplot(freqhi, aes(rejection_rate_for_apples, resid)) +
  geom_point() +
  geom_smooth(color='red')
  # scale_color_manual(values=c("blue","red")) +
  # facet_wrap(~condition) +
  # geom_smooth(aes(color=condition)) +
  # geom_point()
```

Plots show a significant positive correlation between higher rejection rates for apples and higher scores on the task, after the effect of fatigue lowering scores over trials is factored out. Left plot shows correlation lines for each subject separately. Middle plot shows the correlation line for the condition. Zero on the y axis represents the score we would expect for that trial if we only took into account how many trials they had done.

```{r, out.width="30%"}
ggscatter(freqhi %>% mutate(subject=as_factor(subject)), x="rejection_rate_for_apples", y="resid", add='reg.line', conf.int=F, add.params = list(color = "subject", fill = "lightgray"), facet.by='condition') + 
  # stat_cor(method='pearson')+
  theme(legend.position = 'none') + 
  labs(subtitle='line per subject') + 
  ylab("score (residualised)") +
  geom_ref_line(h=0,colour='grey')

ggscatter(freqhi, x="rejection_rate_for_apples", y="resid", add='reg.line', conf.int=T, add.params = list(color = "red", fill = "lightgray"), facet.by='condition') + 
  stat_cor(method='pearson') + 
  labs(subtitle='line for the condition') +
  ylab("score (residualised)") +
  geom_ref_line(h=0,colour='grey')
```


<!-- In the rare bananas condition, ignoring apples is associated with lower scores. In the frequent bananas condition, ignoring apples is associated with higher scores. -->

<!-- ```{r, fig.width=7,fig.height=4} -->
<!-- d=read_csv("d3_trial_by_trial.csv") -->
<!-- ggplot(d, aes(y=ignap, x=score))+ -->
<!--   facet_wrap(~condition)+ -->
<!--   geom_jitter()+ -->
<!--   geom_smooth(aes(colour=condition),method='lm',formula='y~x')+theme(aspect.ratio =1) -->
<!-- ``` -->

<!-- Larger inter-click durations (slower moving around) is associated with lower scores. -->

<!-- ```{r, fig.width=7,fig.height=4} -->
<!-- d=read_csv("d3_trial_by_trial.csv") -->
<!-- ggplot(d, aes(x=score, y=icint))+ -->
<!--   facet_wrap(~condition)+ -->
<!--   geom_jitter()+ -->
<!--   geom_smooth(aes(colour=condition),method='lm',formula='y~x')+theme(aspect.ratio =1) -->
<!-- ``` -->

<!-- foo -->

<!-- ```{r, fig.width=7,fig.height=4} -->
<!-- d=read_csv("d3_trial_by_trial.csv") -->
<!-- ggplot(d, aes(x=ignap, y=ignba))+ -->
<!--   facet_wrap(~condition)+ -->
<!--   geom_jitter()+ -->
<!--   geom_smooth(aes(colour=condition),method='lm',formula='y~x')+theme(aspect.ratio =1) -->
<!-- ``` -->

